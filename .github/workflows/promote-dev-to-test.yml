# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Promote Dev â†’ Test â€” GitHub Actions Workflow
#
# Triggered AUTOMATICALLY when code is pushed to `main` (typically after a
# feature branch PR is merged). This promotes the Dev workspace content to
# the Test workspace via the Fabric Deployment Pipeline.
#
# Flow:
#   Feature PR merged â†’ main updated â†’ Dev workspace Git-syncs automatically
#   â†’ This workflow fires â†’ CLI promotes Dev â†’ Test
#
# Ref: https://learn.microsoft.com/en-us/fabric/cicd/deployment-pipelines/
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Promote Dev â†’ Test

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/CODEOWNERS'
      - '.github/dependabot.yml'
      - '.github/copilot-instructions.md'
      - '.github/PULL_REQUEST_TEMPLATE.md'

  # Allow manual trigger for re-runs
  workflow_dispatch:

# Only one promotion at a time
concurrency:
  group: promote-dev-to-test
  cancel-in-progress: false

jobs:
  promote-dev-to-test:
    name: Promote Development â†’ Test
    runs-on: ubuntu-latest

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      PROJECT_PREFIX: ${{ vars.PROJECT_PREFIX || 'fabric-cicd-demo' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install CLI tool
        run: |
          pip install --upgrade pip
          pip install ms-fabric-cli==${{ vars.FABRIC_CLI_VERSION || '1.3.1' }}
          pip install "git+https://${{ secrets.FABRIC_GITHUB_TOKEN }}@${{ vars.CLI_REPO_URL || 'github.com/BralaBee-LEIT/usf_fabric_cli_cicd_codebase' }}.git@${{ vars.CLI_REPO_REF || 'v1.7.6' }}"

      - name: Verify credentials
        run: |
          for var in AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not configured"
              exit 1
            fi
          done
          echo "âœ… Credentials verified"

      - name: Wait for Fabric Git Sync
        run: |
          echo "â³ Waiting for Fabric to sync main branch to Dev workspace..."
          echo "  Fabric Git Sync typically completes in 30-120 seconds."
          # Wait in increments so logs show progress
          for i in $(seq 1 6); do
            echo "  â±ï¸  Waiting... (${i}0s / 60s)"
            sleep 10
          done
          echo "âœ… Wait complete. Proceeding with promotion."

      - name: Promote Dev â†’ Test
        run: |
          PIPELINE_NAME=$(python -c "
          import os, re, yaml
          config = yaml.safe_load(open('config/projects/demo/base_workspace.yaml'))
          name = config.get('deployment_pipeline', {}).get('pipeline_name', '')
          name = re.sub(r'\\\$\{(\w+)\}', lambda m: os.environ.get(m.group(1), m.group(0)), name)
          print(name)
          ")

          if [ -z "$PIPELINE_NAME" ]; then
            echo "::error::No deployment_pipeline.pipeline_name found in config"
            exit 1
          fi

          echo "ðŸš€ Promoting via pipeline: $PIPELINE_NAME"
          echo "   Source: Development â†’ Target: Test"

          fabric-cicd promote \
            --pipeline-name "$PIPELINE_NAME" \
            --source-stage "Development" \
            --target-stage "Test" \
            --note "Auto-promote from main push (commit: ${{ github.sha }})"

      - name: Report promotion success
        if: success()
        run: |
          echo "## âœ… Promotion: Development â†’ Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Pipeline** | Read from \`base_workspace.yaml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source** | Development |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | Test |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      - name: Report failure
        if: failure()
        run: |
          echo "## âŒ Promotion Failed: Dev â†’ Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
