# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Feature Workspace Creation â€” GitHub Actions Workflow
#
# Triggered when a feature/* branch is pushed. Creates an isolated Fabric
# workspace connected to the feature branch, following Microsoft's Scenario 2
# (develop in a separate workspace) from the official Git integration docs.
#
# Ref: https://learn.microsoft.com/en-us/fabric/cicd/git-integration/manage-branches
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Create Feature Workspace

on:
  push:
    branches:
      - 'feature/**'

# Only allow one workspace creation at a time per branch
concurrency:
  group: feature-ws-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  create-feature-workspace:
    if: startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      GITHUB_TOKEN_FABRIC: ${{ secrets.FABRIC_GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.FABRIC_GITHUB_TOKEN }}
      FABRIC_CAPACITY_ID: ${{ secrets.FABRIC_CAPACITY_ID }}
      DEV_ADMIN_OBJECT_ID: ${{ secrets.DEV_ADMIN_OBJECT_ID }}
      GIT_REPO_URL: ${{ github.server_url }}/${{ github.repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install CLI tool
        run: |
          pip install --upgrade pip
          pip install ms-fabric-cli==1.3.1
          pip install git+https://${{ secrets.FABRIC_GITHUB_TOKEN }}@github.com/BralaBee-LEIT/usf_fabric_cli_cicd_codebase.git@main

      - name: Extract branch info
        id: branch
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          FEATURE_NAME="${BRANCH_NAME#feature/}"
          # Sanitise for Fabric workspace naming (alphanumeric, hyphens, underscores)
          WORKSPACE_SUFFIX=$(echo "$FEATURE_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          echo "workspace_suffix=$WORKSPACE_SUFFIX" >> $GITHUB_OUTPUT

      - name: Verify credentials
        run: |
          for var in AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET FABRIC_CAPACITY_ID; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not configured"
              exit 1
            fi
          done
          echo "âœ… All required credentials verified"

      - name: Deploy feature workspace
        env:
          CONFIG_OVERRIDE: ${{ vars.FEATURE_WORKSPACE_CONFIG || '' }}
        run: |
          # Priority: repo variable > naming convention search
          if [ -n "$CONFIG_OVERRIDE" ]; then
            CONFIG_FILE="$CONFIG_OVERRIDE"
          else
            CONFIG_FILE=$(find config/projects -name "feature_*.yaml" -type f | head -1)
          fi

          if [ -z "$CONFIG_FILE" ] || [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Feature workspace config not found. Either set the FEATURE_WORKSPACE_CONFIG repo variable or add a feature_*.yaml file under config/projects/."
            exit 1
          fi

          echo "ðŸ“¦ Creating feature workspace for branch: ${{ steps.branch.outputs.branch_name }}"
          echo "ðŸ“‹ Using config: $CONFIG_FILE"

          fabric-cicd deploy \
            "$CONFIG_FILE" \
            --env dev \
            --branch "${{ steps.branch.outputs.branch_name }}" \
            --force-branch-workspace

      - name: Report workspace creation
        if: success()
        run: |
          echo "## âœ… Feature Workspace Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.branch.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Feature** | \`${{ steps.branch.outputs.feature_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      - name: Report failure
        if: failure()
        run: |
          echo "## âŒ Feature Workspace Creation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Branch: \`${{ steps.branch.outputs.branch_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
