# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Feature Workspace Cleanup â€” GitHub Actions Workflow
#
# Triggered when a PR to main is merged (and the feature branch is deleted).
# Destroys the corresponding isolated Fabric workspace to free capacity.
#
# SAFETY: By default, uses --safe mode â€” workspaces containing Fabric items
# are protected from accidental deletion. Use force_destroy_populated input
# to override when you're certain the workspace should be deleted with items.
#
# Ref: https://learn.microsoft.com/en-us/fabric/cicd/git-integration/manage-branches
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Cleanup Feature Workspace

on:
  pull_request:
    types: [closed]
    branches: [main]
  # Allow manual cleanup for orphaned workspaces
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Feature branch name (e.g., feature/my-feature)'
        required: true
        type: string
      force_destroy_populated:
        description: 'Force delete even if workspace contains Fabric items (DANGEROUS)'
        required: false
        type: boolean
        default: false

# Prevent parallel cleanup of the same workspace
concurrency:
  group: cleanup-${{ github.event.pull_request.head.ref || inputs.branch_name || 'manual' }}
  cancel-in-progress: false

jobs:
  cleanup-feature-workspace:
    # Only run when a feature branch PR is merged, or manual trigger
    if: >
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true &&
       startsWith(github.event.pull_request.head.ref, 'feature/')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      PROJECT_PREFIX: ${{ vars.PROJECT_PREFIX || 'fabric-cicd-demo' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install CLI tool
        run: |
          pip install --upgrade pip
          pip install ms-fabric-cli==${{ vars.FABRIC_CLI_VERSION || '1.3.1' }}
          pip install "git+https://${{ secrets.FABRIC_GITHUB_TOKEN }}@${{ vars.CLI_REPO_URL || 'github.com/BralaBee-LEIT/usf_fabric_cli_cicd_codebase' }}.git@${{ vars.CLI_REPO_REF || 'v1.7.13' }}"

      - name: Extract branch info
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          else
            BRANCH_NAME="${{ inputs.branch_name }}"
          fi
          FEATURE_NAME="${BRANCH_NAME#feature/}"
          WORKSPACE_SUFFIX=$(echo "$FEATURE_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          echo "workspace_suffix=$WORKSPACE_SUFFIX" >> $GITHUB_OUTPUT

      - name: Verify credentials
        run: |
          for var in AZURE_TENANT_ID AZURE_CLIENT_ID AZURE_CLIENT_SECRET; do
            if [ -z "${!var}" ]; then
              echo "::error::Required secret $var is not configured"
              exit 1
            fi
          done
          echo "âœ… Credentials verified"

      - name: Destroy feature workspace
        env:
          CONFIG_OVERRIDE: ${{ vars.FEATURE_WORKSPACE_CONFIG || '' }}
        run: |
          # Priority: repo variable > naming convention search
          if [ -n "$CONFIG_OVERRIDE" ]; then
            CONFIG_FILE="$CONFIG_OVERRIDE"
          else
            CONFIG_FILE=$(find config/projects -name "feature_*.yaml" -type f | head -1)
          fi

          if [ -z "$CONFIG_FILE" ] || [ ! -f "$CONFIG_FILE" ]; then
            echo "::error::Feature workspace config not found. Either set the FEATURE_WORKSPACE_CONFIG repo variable or add a feature_*.yaml file under config/projects/."
            exit 1
          fi

          BRANCH="${{ steps.branch.outputs.branch_name }}"

          # Safety flags â€” protect populated workspaces by default
          SAFETY_FLAGS="--safe"
          if [ "${{ inputs.force_destroy_populated }}" == "true" ]; then
            SAFETY_FLAGS="--force-destroy-populated"
            echo "âš ï¸  FORCE mode: will delete workspace even if it contains Fabric items"
          else
            echo "ðŸ›¡ï¸  SAFE mode: workspace with Fabric items will be protected"
          fi

          echo "ðŸ§¹ Destroying feature workspace for branch: $BRANCH"

          # Use CLI's --branch flag to derive workspace name identically to deploy
          # CLI handles: not-found (idempotent), InsufficientPrivileges (warning)
          DESTROY_EXIT=0
          fabric-cicd destroy \
            "$CONFIG_FILE" \
            --force \
            $SAFETY_FLAGS \
            --branch "$BRANCH" || DESTROY_EXIT=$?

          # Exit code 2 = safety block (workspace has items, not deleted)
          if [ $DESTROY_EXIT -eq 2 ]; then
            echo "::warning::ðŸ›¡ï¸ Workspace protected â€” contains Fabric items. Use force_destroy_populated=true to override."
            echo "SAFETY_BLOCKED=true" >> $GITHUB_ENV
          elif [ $DESTROY_EXIT -ne 0 ]; then
            echo "::error::Destroy failed with exit code $DESTROY_EXIT"
            exit $DESTROY_EXIT
          fi

      - name: Report cleanup
        if: always()
        run: |
          if [ "$SAFETY_BLOCKED" == "true" ]; then
            echo "## ðŸ›¡ï¸ Feature Workspace Protected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Workspace contains Fabric items and was NOT deleted.**" >> $GITHUB_STEP_SUMMARY
            echo "> Re-run with \`force_destroy_populated: true\` to override." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ§¹ Feature Workspace Cleaned Up" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---|:---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ steps.branch.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Feature** | \`${{ steps.branch.outputs.feature_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Safety Mode** | ${{ inputs.force_destroy_populated == 'true' && 'âš ï¸ Force' || 'ðŸ›¡ï¸ Safe' }} |" >> $GITHUB_STEP_SUMMARY
